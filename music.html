<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Music Collection</title>
<style>
body { font-family: Arial, sans-serif; }
table { border-collapse: collapse; width: 100%; margin-top: 20px; }
th, td { border: 1px solid #ccc; padding: 6px; text-align: left; }
th { background: #f4f4f4; }
button { margin: 5px 0; }
</style>
</head>
<body>

<h2>Music Collection</h2>

<input type="file" id="fileInput" accept=".txt,.tsv">
<button onclick="importTXT()">Import File</button>

<table id="musicTable">
<thead>
<tr>
<th>Album</th>
<th>Artist</th>
<th>Rating</th>
<th>Year</th>
</tr>
</thead>
<tbody>
</tbody>
</table>

<script>

function cleanField(str){
  if(!str) return '';

  // Remove carriage returns and NBSP
  str = str.replace(/\r/g,'').replace(/\u00A0/g,' ');

  // Normalize unicode (fix accented characters)
  str = str.normalize("NFKC");

  // Trim whitespace
  str = str.trim();

  // Remove wrapping straight or smart quotes ONLY
  if(
    (str.startsWith('"') && str.endsWith('"')) ||
    (str.startsWith('“') && str.endsWith('”')) ||
    (str.startsWith('„') && str.endsWith('“')) ||
    (str.startsWith("'") && str.endsWith("'"))
  ){
    str = str.slice(1,-1).trim();
  }

  return str;
}

function normalizeString(str){
  return cleanField(str).toLowerCase();
}

function importTXT(){
  const fileInput = document.getElementById('fileInput');
  const file = fileInput.files[0];
  if(!file){
    alert("Please select a file.");
    return;
  }

  const reader = new FileReader();

  reader.onload = function(e){
    const text = e.target.result;
    const lines = text.split('\n');
    const table = document.getElementById('musicTable').getElementsByTagName('tbody')[0];

    // Build set of existing entries
    const existing = new Set();
    Array.from(table.rows).forEach(row=>{
      const key =
        normalizeString(row.cells[0].innerText) + '|' +
        normalizeString(row.cells[1].innerText);
      existing.add(key);
    });

    const imported = new Set(); // prevent duplicates inside same file

    lines.forEach(line=>{
      if(!line.trim()) return;

      const parts = line.split('\t'); // MUST be tab-delimited
      if(parts.length < 4) return;

      const name = cleanField(parts[0]);
      const artist = cleanField(parts[1]);
      const rating = cleanField(parts[2]);
      const year = cleanField(parts[3]);

      if(!name || !artist) return;

      const key =
        normalizeString(name) + '|' +
        normalizeString(artist);

      // Skip duplicates
      if(existing.has(key) || imported.has(key)) return;

      imported.add(key);

      const newRow = table.insertRow();
      newRow.insertCell(0).innerText = name;
      newRow.insertCell(1).innerText = artist;
      newRow.insertCell(2).innerText = rating;
      newRow.insertCell(3).innerText = year;
    });

    alert("Import complete.");
  };

  // IMPORTANT: Force UTF-8
  reader.readAsText(file, "UTF-8");
}

</script>

</body>
</html>
