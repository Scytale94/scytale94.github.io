<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reading Hub</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>

  <!-- Main Heading -->
  <header>
    <h1>üìö Reading Hub</h1>
  </header>

  <!-- Back Button -->
  <div class="back-button-container">
    <a href="https://scytale94.github.io/" class="tile back-button">‚¨Ö Home</a>
  </div>

  <main>
    <!-- Currently Reading Section -->
    <section id="currently-reading-section" class="section">
      <h2>üìñ Currently Reading</h2>
      <div id="currently-reading" class="shelf-grid">
        <div class="book-card">Loading‚Ä¶</div>
      </div>
    </section>

    <!-- Want to Read Section -->
    <section id="to-read-section" class="section">
      <h2>üìö Want to Read</h2>
      <div id="to-read" class="shelf-grid">
        <div class="book-card">Loading‚Ä¶</div>
      </div>
    </section>

    <!-- Read Books Table -->
    <section id="read-section" class="section">
      <h2>‚úÖ Read Books (Your Records)</h2>

      <!-- Table Controls -->
      <div class="table-controls">
        <input id="input-title" type="text" placeholder="Title (required)">
        <input id="input-author" type="text" placeholder="Author">
        <input id="input-rating" type="number" step="0.1" min="0" max="10" placeholder="Rating (0.0 - 10.0)">
        <button id="add-book">Add</button>
      </div>

      <div class="muted-note">Add books you've finished. Ratings are 0.0‚Äì10.0. Edits and deletions are saved locally.</div>

      <!-- Books Table -->
      <table id="read-table" aria-live="polite">
        <thead>
          <tr>
            <th>Title</th>
            <th>Author</th>
            <th>Rating</th>
            <th>Date Added</th>
            <th style="width:140px">Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>
  </main>

<script>
// Goodreads API setup
const GOODREADS_USER_ID = '145950633';
const GOODSHELF_BASE = `https://www.goodreads.com/review/list_rss/${GOODREADS_USER_ID}?shelf=`;
const ALL_ORIGINS = 'https://api.allorigins.win/raw?url=';

function proxyUrl(url){ return ALL_ORIGINS + encodeURIComponent(url); }
function escapeHtml(str){
  if(!str) return '';
  return str.replace(/[&<>"']/g, ch=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[ch]));
}

// Fetch Goodreads shelves
async function fetchShelf(shelf){
  try {
    const resp = await fetch(proxyUrl(GOODSHELF_BASE + encodeURIComponent(shelf)));
    const text = await resp.text();
    const xml = new DOMParser().parseFromString(text, 'application/xml');
    const items = Array.from(xml.querySelectorAll('item'));
    return items.map(it=>{
      const title = it.querySelector('title')?.textContent || 'Untitled';
      let author = it.querySelector('author name')?.textContent || it.querySelector('author')?.textContent || '';
      const link = it.querySelector('link')?.textContent || '';
      let cover = '';
      const desc = it.querySelector('description')?.textContent || '';
      const m = desc.match(/<img[^>]+src=["']([^"']+)["']/i);
      if(m) cover = m[1];
      return { title, author, link, cover };
    });
  } catch(err){ console.error(err); return []; }
}

function renderShelf(containerId, books){
  const container = document.getElementById(containerId);
  container.innerHTML = '';
  if(!books || books.length===0){
    container.innerHTML = '<div class="book-card">No books found.</div>';
    return;
  }
  books.forEach(b=>{
    const card = document.createElement('div');
    card.className = 'book-card';
    const coverHtml = b.cover ? `<img class="book-cover" src="${b.cover}" alt="${escapeHtml(b.title)}">`
                              : `<div class="book-cover" style="display:flex;align-items:center;justify-content:center;color:#ddd;font-size:0.7rem">No cover</div>`;
    card.innerHTML = `${coverHtml}<div class="book-title">${escapeHtml(b.title)}</div><div class="book-author">${escapeHtml(b.author)}</div><a class="small-link" href="${b.link}" target="_blank">View</a>`;
    container.appendChild(card);
  });
}

async function loadShelves(){
  renderShelf('currently-reading', await fetchShelf('currently-reading'));
  renderShelf('to-read', await fetchShelf('to-read'));
}
loadShelves();

// Local Read Books Table
const STORAGE_KEY = 'booksHub.readBooks.v2';
let readBooks = [];
const tbody = document.querySelector('#read-table tbody');
const inputTitle = document.getElementById('input-title');
const inputAuthor = document.getElementById('input-author');
const inputRating = document.getElementById('input-rating');

function saveBooks(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(readBooks)); }
function loadBooks(){ readBooks = JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]'); }
function renderTable(){
  tbody.innerHTML = '';
  if(readBooks.length===0){ tbody.innerHTML='<tr><td colspan="5" style="color:var(--muted)">No entries yet.</td></tr>'; return; }
  readBooks.forEach((b,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td><strong>${escapeHtml(b.title)}</strong></td>
      <td>${escapeHtml(b.author||'')}</td>
      <td>${b.rating!=null?Number(b.rating).toFixed(1):''}</td>
      <td>${b.addedAt?new Date(b.addedAt).toLocaleDateString():''}</td>
      <td>
        <button class="action-btn" data-act="edit" data-i="${i}">‚úèÔ∏è Edit</button>
        <button class="action-btn" data-act="del" data-i="${i}">üóëÔ∏è Del</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

// Add Book
document.getElementById('add-book').addEventListener('click', ()=>{
  const title = inputTitle.value.trim();
  if(!title){ alert('Enter a title'); return; }
  let rating = inputRating.value.trim();
  rating = rating ? parseFloat(rating) : null;
  if(rating!==null && (isNaN(rating)||rating<0||rating>10)){ alert('Rating must be 0‚Äì10'); return; }
  readBooks.unshift({title, author: inputAuthor.value.trim(), rating, addedAt:new Date().toISOString()});
  saveBooks(); renderTable();
  inputTitle.value = inputAuthor.value = inputRating.value = '';
});

// Edit/Delete Buttons
tbody.addEventListener('click', e=>{
  const btn = e.target.closest('button');
  if(!btn) return;
  const act = btn.dataset.act, i = Number(btn.dataset.i);
  if(act==='del' && confirm('Delete this entry?')){ readBooks.splice(i,1); saveBooks(); renderTable(); }
  else if(act==='edit'){
    const b = readBooks[i];
    const newTitle = prompt('Title', b.title) || b.title;
    const newAuthor = prompt('Author', b.author||'') || b.author;
    let newRating = prompt('Rating (0.0‚Äì10.0)', b.rating ?? '');
    if(newRating==='') newRating=null;
    else { newRating=parseFloat(newRating); if(isNaN(newRating)||newRating<0||newRating>10){alert('Invalid rating');return;} }
    b.title=newTitle.trim(); b.author=newAuthor.trim(); b.rating=newRating;
    saveBooks(); renderTable();
  }
});

loadBooks(); renderTable();
</script>

</body>
</html>
